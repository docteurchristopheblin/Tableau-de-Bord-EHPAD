<script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbworFCiwn7kdqF-eoDbwxMvYVwLUunVAjhy7NYZtwnA2plfTbAJD8AB8MeQoVHY4Wfq/exec";

  function makeGidUrl(sheetId, gid){
    const g = String(gid ?? "0");
    return `https://docs.google.com/spreadsheets/d/${sheetId}/edit?gid=${encodeURIComponent(g)}#gid=${encodeURIComponent(g)}`;
  }

  // ====== CONFIG SITES ======
  const NOGENT = {
    name: "Nogent",
    sheetId: "1eeRp1V9upw967UPEPyf8qJiSa4dwC0ULLoFuojl7nyc",
    gid: "0",
    startCol: 14, labelRow: 1, valueRow: 4, dateRow: 3,
    statusEl: document.getElementById("statusNogent"),
    gridEl: document.getElementById("gridNogent"),
    callback: "handleNogent"
  };

  const PONTPOINT = {
    name: "Pontpoint",
    sheetId: "1GR19n7z3cx5oj9HTY18IqvmT0J7AHT4OUMhItX-xhbo",
    gid: "0",
    startCol: 14, labelRow: 1, valueRow: 4, dateRow: 3,
    statusEl: document.getElementById("statusPontpoint"),
    gridEl: document.getElementById("gridPontpoint"),
    callback: "handlePontpoint"
  };

  const CHAMANT = {
    name: "Chamant",
    sheetId: "1pDLA7POdZA3EOUE-Mpp7hDGlDS3ALszI6RL11G9TA5k",
    gid: "626296930",
    startCol: 14, labelRow: 1, valueRow: 4, dateRow: 3,
    statusEl: document.getElementById("statusChamant"),
    gridEl: document.getElementById("gridChamant"),
    callback: "handleChamant"
  };

  const LAFORET = {
    name: "La For√™t",
    sheetId: "1WqBZ2xacW0g41ZDlj64xEd4a5eoY5x0YgmV-xXPEDvI",
    gid: "0",
    startCol: 14, labelRow: 1, valueRow: 4, dateRow: 3,
    statusEl: document.getElementById("statusLaforet"),
    gridEl: document.getElementById("gridLaforet"),
    callback: "handleLaforet"
  };

  const MONCHY = {
    name: "Monchy",
    sheetId: "1PBOLxDkW16bDy3EsVdjn1nuN8KRfKlBEHieRA1XnllA",
    gid: "0",
    startCol: 14,
    labelRow: 1,
    valueRow: 0,
    dateRow: 3,
    statusEl: document.getElementById("statusMonchy"),
    gridEl: document.getElementById("gridMonchy"),
    callback: "handleMonchy"
  };

  const SITES = [NOGENT, PONTPOINT, CHAMANT, LAFORET, MONCHY];
  for (const site of SITES) site.gidUrl = makeGidUrl(site.sheetId, site.gid);

  // ====== UI ======
  const globalStatus = document.getElementById("globalStatus");
  const toggleBtn = document.getElementById("toggleViewBtn");
  const toggleText = document.getElementById("toggleViewText");
  const toggleHint = document.getElementById("toggleViewHint");
  const modeLabel = document.getElementById("modeLabel");

  let SHOW_ALL_MONTHS = false;
  const LAST_PAYLOAD = new Map();

  // ====== HELPERS ======
  function clamp01(x){
    x = Number(x);
    if (!isFinite(x)) return 0;
    return Math.max(0, Math.min(1, x));
  }
  function pct(x){ return Math.round(clamp01(x)*100); }

  function formatDateFR(x){
    if (x === null || x === undefined || x === "") return "";
    let d;

    if (typeof x === "string") {
      // d√©j√† en dd/mm/yyyy
      const m = x.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})$/);
      if (m) return `${m[1]}/${m[2]}/${m[3]}`;

      // YYYY-MM-DD
      const m2 = x.match(/^(\d{4})[\/\-](\d{2})[\/\-](\d{2})$/);
      if (m2) return `${m2[3]}/${m2[2]}/${m2[1]}`;

      d = new Date(x);
    } else {
      d = new Date(x);
    }

    if (isNaN(d.getTime())) return String(x);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }

  function normalizeMonthLabel(label) {
    const l = String(label || "").toLowerCase();
    const months = {
      janvier:0, fevrier:1, f√©vrier:1, mars:2, avril:3, mai:4, juin:5,
      juillet:6, aout:7, ao√ªt:7, septembre:8, octobre:9, novembre:10, decembre:11, d√©cembre:11
    };

    for (const m in months) {
      if (l.includes(m)) {
        const year = parseInt(l.match(/20\d{2}/)?.[0], 10);
        if (!isNaN(year)) return new Date(year, months[m], 1);
      }
    }

    let mm = l.match(/(\d{1,2})[\/\-](20\d{2})/);
    if (mm) return new Date(parseInt(mm[2], 10), parseInt(mm[1], 10) - 1, 1);

    mm = l.match(/(20\d{2})[\/\-](\d{1,2})/);
    if (mm) return new Date(parseInt(mm[1], 10), parseInt(mm[2], 10) - 1, 1);

    return null;
  }

  function isMonthInWindow(label) {
    if (SHOW_ALL_MONTHS) return true;

    const d = normalizeMonthLabel(label);
    if (!d) return true;

    const now = new Date();
    const cur = new Date(now.getFullYear(), now.getMonth(), 1);
    const min = new Date(cur.getFullYear(), cur.getMonth() - 3, 1);
    const max = new Date(cur.getFullYear(), cur.getMonth() + 1, 1);

    const t = d.getTime();
    return t >= min.getTime() && t <= max.getTime();
  }

  function attachSpotlight(card){
    if (!window.matchMedia || !matchMedia("(hover:hover) and (pointer:fine)").matches) return;
    card.addEventListener("mousemove", (e) => {
      const r = card.getBoundingClientRect();
      const x = ((e.clientX - r.left) / r.width) * 100;
      const y = ((e.clientY - r.top) / r.height) * 100;
      card.style.setProperty("--mx", x.toFixed(1) + "%");
      card.style.setProperty("--my", y.toFixed(1) + "%");
    }, { passive:true });
  }

  // ====== CSS: blink via injected keyframes (no need to edit <style>) ======
  (function injectBlinkCSS(){
    const css = `
      @keyframes billBlink {
        0%, 100% { color: #ef4444; text-shadow: 0 0 10px rgba(239,68,68,.45); }
        50% { color: #f59e0b; text-shadow: 0 0 10px rgba(245,158,11,.45); }
      }
      .billDate.blink {
        animation: billBlink 2s infinite ease-in-out;
        font-weight: 900;
      }
    `;
    const st = document.createElement("style");
    st.textContent = css;
    document.head.appendChild(st);
  })();

  // ====== RENDER ======
  function renderMonthCard(gridEl, label, value, site, billDate){
    const v = clamp01(value);
    const p = pct(v);

    let textColor, c1, c2;
    if (p >= 90) { textColor = "var(--success-color)"; c1="#34d399"; c2="#059669"; }
    else if (p >= 75) { textColor = "var(--warning-color)"; c1="#fbbf24"; c2="#d97706"; }
    else { textColor = "var(--danger-color)"; c1="#f87171"; c2="#dc2626"; }

    const billDateFR = formatDateFR(billDate);
    const shouldBlink = p < 60;

    const size = 120;
    const strokeWidth = 12;
    const center = size / 2;
    const radius = center - strokeWidth / 2;
    const circumference = 2 * Math.PI * radius;
    const dashOffset = circumference * (1 - v);

    const uid = Math.random().toString(36).slice(2, 10);
    const gradId = `grad-${uid}`;

    const card = document.createElement("div");
    card.className = "card";
    card.title = `Ouvrir ${site.name}`;

    if (p >= 90) card.classList.add("bright");
    else if (p < 75) card.classList.add("matte");

    card.addEventListener("click", () => {
      if (site.gidUrl) window.open(site.gidUrl, "_blank", "noopener");
    });

    card.setAttribute("role", "link");
    card.setAttribute("tabindex", "0");
    card.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); card.click(); }
    });

    card.innerHTML = `
      <div class="month">${label}</div>

      <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="chart-svg" aria-label="${label}">
        <defs>
          <linearGradient id="${gradId}" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="${c1}" />
            <stop offset="100%" stop-color="${c2}" />
          </linearGradient>

          <linearGradient id="${gradId}-bevel" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="rgba(255,255,255,.65)" />
            <stop offset="40%" stop-color="rgba(255,255,255,.15)" />
            <stop offset="100%" stop-color="rgba(0,0,0,.4)" />
          </linearGradient>
        </defs>

        <g transform="rotate(-90 ${center} ${center})">
          <circle cx="${center}" cy="${center}" r="${radius}" class="chart-circle-bg"></circle>

          <circle data-role="shadow"
            cx="${center}" cy="${center}" r="${radius}"
            fill="none"
            stroke="url(#${gradId})"
            stroke-width="${strokeWidth+2}"
            stroke-linecap="round"
            stroke-dasharray="${circumference}"
            stroke-dashoffset="${circumference}"
            opacity="0.35">
          </circle>

          <circle data-role="fg" cx="${center}" cy="${center}" r="${radius}" class="chart-circle-fg"
            stroke="url(#${gradId})"
            stroke-dasharray="${circumference}"
            stroke-dashoffset="${circumference}">
          </circle>

          <circle data-role="bevel"
            cx="${center}" cy="${center}" r="${radius-1}"
            fill="none"
            stroke="url(#${gradId}-bevel)"
            stroke-width="2"
            stroke-dasharray="${circumference}"
            stroke-dashoffset="${circumference}">
          </circle>
        </g>

        <text x="${center}" y="${center}" dy=".35em" class="chart-text" fill="${textColor}">${p}%</text>
      </svg>

      <div class="pctline" style="color:${textColor}">
        Facturation :
        <span class="billDate ${shouldBlink ? "blink" : ""}">
          ${billDateFR || "‚Äî"}
        </span>
      </div>

      <div class="barWrap">
        <div class="bar" style="background:linear-gradient(90deg, ${c1}, ${c2});"></div>
      </div>
    `;

    gridEl.appendChild(card);
    attachSpotlight(card);

    requestAnimationFrame(() => {
      const fg = card.querySelector('circle[data-role="fg"]');
      const bevel = card.querySelector('circle[data-role="bevel"]');
      const shadow = card.querySelector('circle[data-role="shadow"]');
      if (fg) fg.setAttribute("stroke-dashoffset", String(dashOffset));
      if (bevel) bevel.setAttribute("stroke-dashoffset", String(dashOffset));
      if (shadow) shadow.setAttribute("stroke-dashoffset", String(dashOffset));
      const bar = card.querySelector(".bar");
      if (bar) bar.style.width = `${p}%`;
    });
  }

  // ====== ERRORS ======
  function setSiteError(site, msg){
    site.statusEl.classList.add("hasError");
    site.statusEl.style.display = "block";
    site.statusEl.innerHTML = `<div class="err">${site.name} : ${msg}</div>`;
  }

  // ====== LOAD ======
  function loadSite(site){
    site.statusEl.innerHTML = "";
    site.statusEl.classList.remove("hasError");
    site.gridEl.innerHTML = "";

    const src = `${WEBAPP_URL}?sheetId=${encodeURIComponent(site.sheetId)}&gid=${encodeURIComponent(site.gid)}`
      + `&startCol=${encodeURIComponent(site.startCol)}`
      + `&labelRow=${encodeURIComponent(site.labelRow)}`
      + `&valueRow=${encodeURIComponent(site.valueRow)}`
      + `&dateRow=${encodeURIComponent(site.dateRow)}`
      + `&callback=${encodeURIComponent(site.callback)}&_=${Date.now()}`;

    const s = document.createElement("script");
    s.src = src;

    s.onerror = () => setSiteError(site, "chargement WebApp impossible");

    setTimeout(() => {
      if (!LAST_PAYLOAD.get(site.name)) setSiteError(site, "aucun retour de la WebApp");
    }, 7000);

    document.head.appendChild(s);
  }

  // ====== PAYLOAD -> RENDER ======
  function renderFromPayload(site, payload){
    if(!payload || !payload.ok){
      const msg = payload && payload.error ? payload.error : "erreur de lecture";
      setSiteError(site, msg);
      site.gridEl.innerHTML = "";
      return;
    }

    // IMPORTANT : on n'affiche plus aucune "m√©ta" type "D√©part O ¬∑ Titres ligne 2 ¬∑ Valeurs ligne 5"
    // M√™me si la WebApp renvoie payload.meta, on l'ignore ici.

    const raw = payload.items || [];
    const items = raw.filter(it => isMonthInWindow(it.label));

    if(!items.length){
      setSiteError(site, "aucun mois √† afficher (filtre actif)");
      site.gridEl.innerHTML = "";
      return;
    }

    site.gridEl.innerHTML = "";
    items.forEach(it => renderMonthCard(site.gridEl, it.label, it.value, site, it.billDate));
  }

  // ====== TOP STATUS ======
  function updateGlobalStatus(){
    const mode = SHOW_ALL_MONTHS ? "Tous les mois" : "M-3‚ÜíM+1";
    globalStatus.innerHTML = `üöÄ Charg√© ¬∑ <span class="muted">Clic sur un mois pour ouvrir la feuille</span>`;
    modeLabel.textContent = mode;
  }

  function updateToggleButton(){
    if (SHOW_ALL_MONTHS){
      toggleText.textContent = "Revenir √† la vue M-3 ‚Üí M+1";
      toggleHint.textContent = "Affiche 3 mois avant + mois courant + 1 mois apr√®s";
    } else {
      toggleText.textContent = "Voir tous les mois";
      toggleHint.textContent = "Affiche toutes les colonnes (sans filtre)";
    }
  }

  function rerenderAll(){
    for (const site of SITES){
      const p = LAST_PAYLOAD.get(site.name);
      if (p) renderFromPayload(site, p);
    }
    updateGlobalStatus();
    updateToggleButton();
  }

  // ====== JSONP CALLBACKS ======
  window.handleNogent = (payload) => { LAST_PAYLOAD.set("Nogent", payload); renderFromPayload(NOGENT, payload); };
  window.handlePontpoint = (payload) => { LAST_PAYLOAD.set("Pontpoint", payload); renderFromPayload(PONTPOINT, payload); };
  window.handleChamant = (payload) => { LAST_PAYLOAD.set("Chamant", payload); renderFromPayload(CHAMANT, payload); };
  window.handleLaforet = (payload) => { LAST_PAYLOAD.set("La For√™t", payload); renderFromPayload(LAFORET, payload); };
  window.handleMonchy = (payload) => { LAST_PAYLOAD.set("Monchy", payload); renderFromPayload(MONCHY, payload); };

  // ====== EVENTS ======
  toggleBtn.addEventListener("click", () => {
    SHOW_ALL_MONTHS = !SHOW_ALL_MONTHS;
    rerenderAll();
  });

  // ====== INIT ======
  globalStatus.textContent = "‚è≥ Initialisation et chargement‚Ä¶";
  updateToggleButton();
  updateGlobalStatus();

  loadSite(NOGENT);
  loadSite(PONTPOINT);
  loadSite(CHAMANT);
  loadSite(LAFORET);
  loadSite(MONCHY);

  setTimeout(updateGlobalStatus, 900);
</script>
